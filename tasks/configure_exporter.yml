---
- name: "{{ _exporter.name }} | Check if base service file exists"
  ansible.builtin.stat:
    path: "/etc/systemd/system/{{ _exporter.name }}.service"
  register: _exporter_service_file

- name: "{{ _exporter.name }} | Copy base service file from binary_name variant"
  ansible.builtin.copy:
    src: "/etc/systemd/system/{{ _exporter.binary_name }}.service"
    dest: "/etc/systemd/system/{{ _exporter.name }}.service"
    remote_src: true
    owner: root
    group: root
    mode: "0644"
  when:
    - not _exporter_service_file.stat.exists
    - _exporter.binary_name is defined

- name: "{{ _exporter.name }} | Create systemd drop-in directory"
  ansible.builtin.file:
    path: "/etc/systemd/system/{{ _exporter.name }}.service.d"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: "{{ _exporter.name }} | Configure exporter via systemd drop-in"
  ansible.builtin.template:
    src: exporter_override.conf.j2
    dest: "/etc/systemd/system/{{ _exporter.name }}.service.d/override.conf"
    owner: root
    group: root
    mode: "0644"
  register: _exporter_dropin

- name: "{{ _exporter.name }} | Reload systemd" # noqa no-handler
  ansible.builtin.systemd:
    daemon_reload: true
  when: _exporter_dropin.changed
